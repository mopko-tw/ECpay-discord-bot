# ECPay Discord Bot - CI/CD Pipeline
# è‡ªå‹•åŒ–å»ºç½®ã€æ¸¬è©¦å’Œç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥

name: ECPay Discord Bot CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  security-events: write

jobs:
  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality Check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort bandit safety
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Code formatting check with Black
      run: |
        black --check --diff .
        
    - name: Import sorting check with isort
      run: |
        isort --check-only --diff .
        
    - name: Lint with flake8
      run: |
        # åœæ­¢å»ºç½®å¦‚æœæœ‰Pythonèªæ³•éŒ¯èª¤æˆ–æœªå®šç¾©çš„åç¨±
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # å°‡æ‰€æœ‰éŒ¯èª¤è¦–ç‚ºè­¦å‘Šï¼ŒGitHubç·¨è¼¯å™¨å¯¬åº¦ç‚º127å­—å…ƒ
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
    - name: Security check with Bandit
      run: |
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -f txt
        
    - name: Dependency security check
      run: |
        safety check --json --output safety-report.json || true
        safety check

  # å¤šç‰ˆæœ¬Pythonæ¸¬è©¦
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]
        
    name: Test Python ${{ matrix.python-version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-asyncio
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Create test config
      run: |
        cp config.example.py config.py
        
    - name: Test import modules
      run: |
        python -c "import main; print('âœ… main.py å°å…¥æˆåŠŸ')"
        python -c "import ecpay_handler; print('âœ… ecpay_handler.py å°å…¥æˆåŠŸ')"
        python -c "from commands import payment_commands; print('âœ… payment_commands.py å°å…¥æˆåŠŸ')"
        
    - name: Run syntax check
      run: |
        python -m py_compile main.py
        python -m py_compile ecpay_handler.py
        python -m py_compile commands/payment_commands.py
        echo "âœ… æ‰€æœ‰Pythonæª”æ¡ˆèªæ³•æª¢æŸ¥é€šé"
        
    - name: Test ECPay handler
      run: |
        python -c "
        from ecpay_handler import ECPayHandler
        handler = ECPayHandler()
        print('âœ… ECPayè™•ç†å™¨åˆå§‹åŒ–æˆåŠŸ')
        print('æ”¯æ´çš„ä»˜æ¬¾æ–¹å¼:', list(handler.payment_methods.keys()))
        "

  # Discord Botç‰¹å®šæª¢æŸ¥
  discord-bot-check:
    runs-on: ubuntu-latest
    name: Discord Bot Validation
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Check Discord.py version compatibility
      run: |
        python -c "
        import discord
        print(f'Discord.py ç‰ˆæœ¬: {discord.__version__}')
        if discord.version_info.major >= 2:
            print('âœ… Discord.py v2+ å…¼å®¹')
        else:
            print('âŒ éœ€è¦Discord.py v2+')
            exit(1)
        "
        
    - name: Validate bot commands structure
      run: |
        python -c "
        import sys
        sys.path.append('.')
        from commands.payment_commands import PaymentCommands
        print('âœ… æŒ‡ä»¤æ¨¡å¡Šçµæ§‹é©—è­‰é€šé')
        "
        
    - name: Check configuration files
      run: |
        if [ ! -f config.example.py ]; then
          echo 'âŒ config.example.py ä¸å­˜åœ¨'
          exit 1
        fi
        
        python -c "
        import config
        required_vars = ['BOT_VERSION', 'ECPAY_CONFIG', 'LOG_CONFIG']
        for var in required_vars:
            if not hasattr(config, var):
                print(f'âŒ ç¼ºå°‘å¿…è¦é…ç½®: {var}')
                exit(1)
        print('âœ… é…ç½®æª”æ¡ˆé©—è­‰é€šé')
        "

  # æ–‡ä»¶æª¢æŸ¥
  documentation-check:
    runs-on: ubuntu-latest
    name: Documentation Check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check README files
      run: |
        if [ ! -f README.md ]; then
          echo 'âŒ README.md ä¸å­˜åœ¨'
          exit 1
        fi
        
        if [ ! -d readme ]; then
          echo 'âŒ readme è³‡æ–™å¤¾ä¸å­˜åœ¨'
          exit 1
        fi
        
        echo 'âœ… æ–‡ä»¶çµæ§‹æª¢æŸ¥é€šé'
        
    - name: Check version consistency
      run: |
        VERSION=$(python -c "from config import BOT_VERSION; print(BOT_VERSION)")
        echo "æª¢æ¸¬åˆ°ç‰ˆæœ¬: $VERSION"
        
        if [ -f "readme/README_v${VERSION}.md" ]; then
          echo "âœ… ç‰ˆæœ¬åŒ–READMEå­˜åœ¨: README_v${VERSION}.md"
        else
          echo "âŒ ç¼ºå°‘ç‰ˆæœ¬åŒ–README: README_v${VERSION}.md"
          exit 1
        fi

  # å»ºç½®æ‘˜è¦
  build-summary:
    runs-on: ubuntu-latest
    needs: [code-quality, test, discord-bot-check, documentation-check]
    name: Build Summary
    if: always()
    
    steps:
    - name: Build Summary
      run: |
        echo "ğŸ‰ ECPay Discord Bot CI/CD å®Œæˆ"
        echo "ğŸ“Š å»ºç½®çµæœæ‘˜è¦:"
        echo "- ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥: ${{ needs.code-quality.result }}"
        echo "- å¤šç‰ˆæœ¬æ¸¬è©¦: ${{ needs.test.result }}"
        echo "- Discord Botæª¢æŸ¥: ${{ needs.discord-bot-check.result }}"
        echo "- æ–‡ä»¶æª¢æŸ¥: ${{ needs.documentation-check.result }}"
        
        if [ "${{ needs.code-quality.result }}" = "success" ] && \
           [ "${{ needs.test.result }}" = "success" ] && \
           [ "${{ needs.discord-bot-check.result }}" = "success" ] && \
           [ "${{ needs.documentation-check.result }}" = "success" ]; then
          echo "âœ… æ‰€æœ‰æª¢æŸ¥é€šéï¼Œå¯ä»¥å®‰å…¨éƒ¨ç½²ï¼"
        else
          echo "âŒ éƒ¨åˆ†æª¢æŸ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸Šè¿°çµæœ"
          exit 1
        fi
